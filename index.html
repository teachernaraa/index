<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checking access...</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .card { max-width: 520px; margin:auto; padding:1.25rem; border:1px solid #ddd; border-radius:14px; }
    .ok { color: #0a7f2e; }
    .err { color: #b00020; }
    .muted { color:#666; font-size:14px; }
    a.btn { display:inline-block; padding:.6rem 1rem; border-radius:10px; text-decoration:none; border:1px solid #ccc; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Access check</h2>
    <div id="msg" class="muted">‚è≥ Validating token...</div>
    <div id="actions" style="margin-top:12px;"></div>
  </div>

  <script>
    // üîß –¢–ê–ù–´ WEB APP URL-–∞–∞ —ç–Ω–¥ –æ—Ä—É—É–ª–Ω–∞:
    const WEBAPP = "https://script.google.com/macros/s/AKfycbw7bpvr0lIMsz3un-KV67u5NPUpCrdlMv10G8HGDKDYXTuzO5xx5kZPnYmPlqZvUXw6Jg/exec"; // –∂: https://script.google.com/macros/s/AKfycb.../exec

    const params = new URLSearchParams(location.search);
    const token  = params.get("key") || params.get("token"); // ?key=... —ç—Å–≤—ç–ª ?token=...
    const msg    = document.getElementById("msg");
    const act    = document.getElementById("actions");

    if (!token) {
      msg.className = "err";
      msg.textContent = "‚ùå Token not provided. Use ?key=TOKEN in URL.";
    } else {
      // JSONP callback –Ω—ç—Ä
      const cbName = "handleCheck_" + Math.random().toString(36).slice(2);

      // Callback —Ñ—É–Ω–∫—Ü–∏–π–≥ –≥–∞—Ä–≥–∞–∂ ”©–≥–Ω”©
      window[cbName] = function (data) {
        if (data && data.status === "ok" && data.url) {
          msg.className = "ok";
          msg.textContent = "‚úÖ Access granted. Redirecting...";
          // 1 —Å–µ–∫—É–Ω–¥ —Ö“Ø–ª—ç—ç–≥—ç—ç–¥ —Å–æ–ª–∏—Ö
          setTimeout(() => { location.replace(data.url); }, 800);
        } else {
          msg.className = "err";
          msg.textContent = "‚ùå Access denied.";
          act.innerHTML = '<a class="btn" href="." >Try again</a>';
        }
        // script tag-–∞–∞ —Ü—ç–≤—ç—Ä–ª—ç–Ω—ç
        script.remove();
        delete window[cbName];
      };

      // JSONP script —Ç–∞–≥ ‚Äî CORS –∞—Å—É—É–¥–∞–ª–≥“Ø–π–≥—ç—ç—Ä GAS —Ä—É—É —Ö“Ø—Å—ç–ª—Ç —è–≤—É—É–ª–Ω–∞
      const script = document.createElement("script");
      script.src = `${WEBAPP}?key=${encodeURIComponent(token)}&callback=${cbName}`;
      script.onerror = function() {
        msg.className = "err";
        msg.textContent = "‚ùå Network error calling server.";
      };
      document.body.appendChild(script);
    }
  </script>
</body>
</html>
